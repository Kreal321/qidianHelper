var ywguid,ywkey,userName,token=null,referObject=0,timeleft=0,refreshleft=0;const sourceURL="https://my.qidian.com/ajax/Score/Receive",levelURL="https://my.qidian.com/level";var p2countdown,p2refresh,connectionMsg,message,log,reconnectNum=0;const successMsg="成功";function reconnect(){switch(reconnectNum){case 0:connectionMsg="网络连接错误 (1/3)",writeLog("尝试重新连接 (1/3)"),reconnectNum++,refresh(10);break;case 1:connectionMsg="网络连接错误 (2/3)",writeLog("尝试重新连接 (2/3)"),reconnectNum++,refresh(60);break;case 2:connectionMsg="网络连接错误 (3/3)",writeLog("尝试重新连接 (3/3)"),reconnectNum++,refresh(300);break;default:connectionMsg="网络连接错误，程序已暂停",writeLog("尝试重新连接失败，程序已暂停")}}function timeToStr(){var e=new Date,t=e.getFullYear(),o=e.getMonth()+1,n=e.getDate();o<10&&(o="0"+o),n<10&&(n="0"+n);var r=e.getHours(),c=e.getMinutes(),l=e.getSeconds();return r<10&&(r="0"+r),c<10&&(c="0"+c),l<10&&(l="0"+l),t+"/"+o+"/"+n+" "+r+":"+c+":"+l}function writeLog(e){message=e,$("#log").append("<br>"+timeToStr()+"  "+e)}function readLog(){log=(log=$("#log").html())+"<br> 更新于 "+timeToStr()}function timeToTmr(){var e=new Date,t=24-e.getTimezoneOffset()/60-8,o=new Date(e);o.setDate(o.getDate()+1),o.setHours(0,0,1);var n=(o.getTime()-e.getTime())/1e3+3600*t;return n>=86400&&(n-=86400),console.log(n/3600),writeLog("距离明天0点还有 "+n+" 秒"),n}function timeLeft(e,t){writeLog("尝试获取起点level页面"),null!=token?(connectionMsg=null,$.get(e,function(e){var o=e.substring(e.indexOf('<ul id="elTaskWrap">'),e.indexOf("<h3>职业</h3>"));$("#content").html(o);var n=$("ul#elTaskWrap").find(".elGetExp"),r=$("ul#elTaskWrap").find(".elIsCurrent");null!=n.attr("data-num")?(referObject=n.attr("data-num"),timeleft=0,writeLog("更新成功：第 "+referObject+" 个在线时长待领取"),console.log("get:"+referObject+": "+timeleft),t()):null!=r.attr("data-num")?(referObject=r.attr("data-num"),timeleft=r.attr("data-timeleft"),writeLog("更新成功：第 "+referObject+" 个在线时长 "+timeleft+" 秒后可领取"),console.log("current:"+referObject+": "+timeleft),t()):o.length>10?(referObject=9,writeLog("更新成功：今日在线时长奖励已全部领取"),refresh(timeToTmr())):(console.log("账户失效"),stop("失败：原因账户失效，请重新登录，程序已暂停"))}).fail(function(e){stop("失败：原因网络错误："+e.status+": "+e.statusText),console.log("网络错误 "+e.status+": "+e.statusText),reconnect()})):stop("失败：原因阅文账户未登录")}function getEXP(e){writeLog("尝试领取第 "+referObject+" 个在线时长奖励"),$.get(sourceURL,{_csrfToken:token,referObject:referObject},function(t){console.log(t),null!=t.msg?t.msg==successMsg?(console.log("领取成功"),writeLog("领取成功：第 "+referObject+" 个在线时长成功领取"),e(0)):(console.log(t.msg),stop("失败：原因"+t.msg+"，第 "+referObject+" 个在线时长未领取"),e(10)):(console.log("账户失效，无法访问"),stop("失败：原因账户失效，请重新登录，程序已暂停"))}).fail(function(e){stop("失败：原因网络错误："+e.status+": "+e.statusText),console.log("网络错误 "+e.status+": "+e.statusText),reconnect()})}function countdown(){writeLog("计划于 "+timeleft+" 秒后领取在线时长奖励"),null!=p2countdown&&(clearTimeout(p2countdown),console.log("p2countdown: clear")),p2countdown=setInterval(function(){timeleft--,console.log("timeleft: "+timeleft),timeleft<=0&&(clearTimeout(p2countdown),console.log("p2countdown: clear"),getEXP(function(e){refresh(e)}))},1e3)}function refresh(e){writeLog("计划于 "+(refreshleft=e)+" 秒后更新数据"),null!=p2refresh&&(clearTimeout(p2refresh),console.log("p2refresh: clear")),p2refresh=setInterval(function(){refreshleft--,console.log("refreshleft: "+refreshleft),refreshleft<=0&&(clearTimeout(p2refresh),console.log("p2refresh: clear"),timeLeft(levelURL,function(){reconnectNum=0,connectionMsg=null,countdown()}))},1e3)}function stop(e){null!=p2refresh&&(clearTimeout(p2refresh),console.log("p2refresh: clear")),null!=p2countdown&&(clearTimeout(p2countdown),console.log("p2countdown: clear")),refreshleft=-1,timeleft=-1,writeLog(e)}$(document).ready(function(){$("body").html('<div id="content"></div><div id="log"></div>')});