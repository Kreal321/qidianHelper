var bg=chrome.extension.getBackgroundPage(),myChart=null,dataLabels=["","","","","","",""],dataData=[0,0,0,0,0,0,0];const qidian="qidian.com",stateURL="https://my.qidian.com/ajax/message/state",listURL="https://my.qidian.com/ajax/Score/List",successMsg="成功";function getCookies(t,e,a){bg.writeLog("尝试获取cookie："+e),chrome.cookies.get({url:t,name:e},function(t){console.log(t),null!=t?(bg.writeLog("获取成功："+e+"："+t.value),a(t.value)):(bg.stop("失败：原因cookie："+e+" 不存在，程序已停止"),a(!1))})}function loginStatus(t){bg.writeLog("正在验证账户登录有效性"),$.get(stateURL,function(e){console.log(e),null!=e.msg?e.msg==successMsg?(bg.userName=e.data.userName,console.log("账户登录有效"),bg.writeLog("验证成功：阅文账户 "+bg.ywguid+" 登录有效"),t()):(console.log("账户登录失败"+url+": "+e.msg),bg.stop("失败：原因其它："+e.msg+"程序已停止")):($("#login").html("阅文账户失效"),$("#user-name").html("账户失效，请重新登录"),console.log("账户失效，无法访问"),bg.stop("失败：原因账户失效，请重新登录，程序已暂停"))}).fail(function(t){$("#login").html("无法连接至阅文官网"),$("#user-name").html("网络错误，请检查网络连接"),bg.stop("失败：原因网络错误："+t.status+": "+t.statusText+"，请检查网络连接，程序已停止"),console.log("网络错误 "+t.status+": "+t.statusText)})}function createChart(){bg.writeLog("正在生成图表");var t=document.getElementById("Exp-chart").getContext("2d"),e=t.createLinearGradient(500,0,100,0);e.addColorStop(0,"#80b6f4"),e.addColorStop(1,"#FFFFFF");var a=t.createLinearGradient(0,170,0,50);a.addColorStop(0,"rgba(128, 182, 244, 0)"),a.addColorStop(1,"rgba(249, 99, 59, 0.40)"),myChart=new Chart(t,{type:"line",responsive:!0,data:{labels:dataLabels,datasets:[{label:"获得经验值",borderColor:"#f96332",pointBorderColor:"#FFF",pointBackgroundColor:"#f96332",pointBorderWidth:2,pointHoverRadius:4,pointHoverBorderWidth:1,pointRadius:4,fill:!0,backgroundColor:a,borderWidth:2,data:dataData}]},options:{maintainAspectRatio:!1,legend:{display:!1},tooltips:{bodySpacing:4,mode:"nearest",intersect:0,position:"nearest",xPadding:10,yPadding:10,caretPadding:10},responsive:1,scales:{yAxes:[{display:0,gridLines:0,ticks:{display:!1},gridLines:{zeroLineColor:"transparent",drawTicks:!1,display:!1,drawBorder:!1}}],xAxes:[{display:0,gridLines:0,ticks:{display:!1},gridLines:{zeroLineColor:"transparent",drawTicks:!1,display:!1,drawBorder:!1}}]},layout:{padding:{left:0,right:0,top:15,bottom:15}}}})}function initialChartData(){null==myChart&&createChart(),bg.writeLog("正在初始化图表数据");var t=new Date,e=24-t.getTimezoneOffset()/60-8;t.setHours(t.getHours()+e);for(var a=6;a>=0;a--){var o=t.getMonth()+1,s=t.getDate();o<10&&(o="0"+o),s<10&&(s="0"+s),dataLabels[a]=o+"-"+s,t.setDate(t.getDate()-1)}dataData=[0,0,0,0,0,0,0],myChart.data.labels=dataLabels,myChart.data.datasets[0].data=dataData,myChart.update(),console.log(dataLabels)}function getPastEXP(t){bg.writeLog("尝试获取历史经验值记录"),$.get(listURL,{_csrfToken:bg.token},function(e){console.log(e),null!=e.msg?e.msg==successMsg?(console.log("获取成功"),bg.writeLog("获取成功：阅文账户 "+bg.ywguid+" 历史经验值已获取"),t(e)):(console.log(e.msg),bg.stop("失败：原因"+e.msg)):(console.log("账户失效，无法访问"),bg.stop("失败：原因账户失效，请重新登录，程序已暂停"))}).fail(function(t){bg.stop("失败：原因网络错误："+t.status+": "+t.statusText),console.log("网络错误 "+t.status+": "+t.statusText),reconnect()})}function calculatePastEXP(t){getPastEXP(function(e){bg.writeLog("正在计算近七天经验值记录"),e=e.data;var a=new Array(7),o={},s=null,r=0,n=0,i=0;for(n=0;n<e.totalCount;n++){var l=e.listInfo[n].createTime.substring(5,10);if(s==l)r+=e.listInfo[n].score;else{if(null!=s){var g={};g.date=s,g.num=r,a[i]=g,i++}s=l,r=e.listInfo[n].score}}o.data=a,o.count=i,console.log(o),t(o)})}function refreshChartData(){bg.writeLog("正在更新图表数据"),initialChartData(),calculatePastEXP(function(t){for(var e=0;e<t.count;e++)dataData[dataLabels.indexOf(t.data[e].date)]=t.data[e].num;console.log(dataData),myChart.data.datasets[0].data=dataData,myChart.update()})}$(document).ready(function(){$("body").height($(".navbar").height()+$(".content").height()),initialChartData(),$("#btn-login").click(function(){$.get("https://www.1.com",{url:"111"},function(t){alert(t)}).fail(function(t){console.log(t),alert("错误")})}),chrome.tabs.getSelected(null,function(t){bg.writeLog("获取当前页面信息"),-1!=t.url.indexOf(qidian)?(bg.writeLog("当前页面为起点页面"),bg.writeLog("尝试获取登录信息"),getCookies("https://*.qidian.com","ywguid",function(t){t?(bg.ywguid=t,$("#login").html("已登录阅文账户："+bg.ywguid),$("#user-name").html("正在验证账户登录有效性"),getCookies("https://*.qidian.com","_csrfToken",function(t){t?(bg.token=t,$("#token").html("Token："+bg.token),loginStatus(function(){$("#user-name").html("你好，"+bg.userName),$("#status").html("正在获取状态..."),bg.refresh(0),refreshChartData()})):(bg.stop("失败：原因token信息错误，请刷新页面，程序已停止"),$("#login").html("阅文账户错误"),$("#user-name").html("请刷新起点页面"))})):(bg.stop("失败：原因起点未登录，请先登录起点，程序已停止"),$("#login").html("起点未登录"),$("#user-name").html("请先登录起点"))})):(bg.writeLog("当前页面为非起点页面"),bg.writeLog("尝试获取登录信息"),null!=bg.userName&&null!=bg.token?(bg.writeLog("获取成功：后台已登录阅文账户"+bg.ywguid),$("#login").html("后台已登录："+bg.ywguid),$("#user-name").html("你好，"+bg.userName),loginStatus(function(){$("#user-name").html("你好，"+bg.userName),$("#status").html("正在获取状态..."),bg.refresh(0)})):(bg.stop("失败：原因后台未登录，程序已停止"),$("#login").html("后台未登录"),$("#user-name").html("打开起点并登陆后重新点击此插件")))});setInterval(function(){$("#msg").val(bg.message);const t='<a href="#" style="color: #9a9a9a;"><i class="now-ui-icons arrows-1_refresh-69"></i></a> ';null!=bg.token?null!=bg.connectionMsg&&bg.reconnectNum<3?$("#refresh-status").html(t+bg.connectionMsg+"，"+bg.refreshleft+" 秒后重连"):3==bg.reconnectNum?$("#refresh-status").html(t+bg.connectionMsg):bg.refreshleft>0?($("#refresh-status").html(t+"计划于 "+bg.refreshleft+" 秒后更新数据"),9==bg.referObject&&$("#msg").val("今日在线时长奖励已经全部领取")):-1==bg.refreshleft&&(bg.timeleft>=0?$("#refresh-status").html(t+"更新成功："+bg.referObject+"/8：剩余 "+bg.timeleft+"秒"):$("#refresh-status").html(t+"更新成功")):$("#refresh-status").html(t+"更新成功")},1e3);$("#btn-log").click(function(){bg.readLog(),$("#log").html('<div class="alert alert-primary"  id="logMsg" style="height: 200px; width: 380px; overflow:auto;"></div>'),$("#logMsg").append("后台运行日志："+bg.log),document.getElementById("logMsg").scrollTop=document.getElementById("logMsg").scrollHeight}),$("#refresh-status").click(function(){null!=bg.token?(bg.refresh(0),refreshChartData(),$("#pg-resume").hide(),$("#pg-stop").show()):($("#pg-resume").hide(),$("#pg-stop").hide()),$("#refresh-status").html('<a href="#" style="color: #9a9a9a;"><i class="now-ui-icons arrows-1_refresh-69 spin"></i></a> 刷新中')}),$("#pg-resume").hide(),$("#pg-resume").click(function(){null!=bg.token&&(bg.refresh(0),refreshChartData()),$("#refresh-status").html('<a href="#" style="color: #9a9a9a;"><i class="now-ui-icons arrows-1_refresh-69 spin"></i></a> 刷新中'),$("#pg-resume").hide(),$("#pg-stop").show()}),$("#pg-stop").click(function(){initialChartData(),bg.stop("程序已停止"),$("#refresh-status").html('<a href="#" style="color: #9a9a9a;"><i class="now-ui-icons arrows-1_refresh-69 spin"></i></a> 刷新中'),$("#pg-resume").show(),$("#pg-stop").hide()}),$("#pg-logout").click(function(){bg.token=null,initialChartData(),bg.refresh(0),bg.stop("阅文账户已退出"),$("#pg-login").html("登录"),$("#pg-resume").hide(),$("#pg-stop").hide(),$("#pg-logout").hide(),$("#login").html("阅文账户已退出"),$("#user-name").html("成功退出"),$("#refresh-status").html('<a href="#" style="color: #9a9a9a;"><i class="now-ui-icons arrows-1_refresh-69 spin"></i></a> 刷新中')})});